<?xml version="1.0" encoding="UTF-8"?>
<Consultas>
    <Consulta id="get_usuario">
        <sql>
        SELECT usuario_id from usuario where usuario_usuario=$usuario_usuario and usuario_pwd=md5($usuario_pwd)
        </sql>
    </Consulta>
    <Consulta id="validate_user">
        <sql>
        SELECT usuario_id from usuario where usuario_usuario=token and usuario_pwd=md5($usuario_pwd)
        </sql>
    </Consulta>
    <Consulta id="update_clave">
        <sql>
        update usuario set usuario_pwd=md5($usuario_pwd_new) where usuario_usuario=token returning usuario_id
        </sql>
    </Consulta>
    <Consulta id="info1_general_proyecto">
        <sql>
        select * from info1_general_proyecto where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info2_general_predio">
        <sql>
        select * from info2_general_predio where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info3_areas_usos">
        <sql>
        select * from info3_areas_usos where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info4_avaluos">
        <sql>
        select * from info4_avaluos where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info5_juridicos">
        <sql>
        select * from info5_juridicos where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info6_propietario_anterior_juridico">
        <sql>
        select * from info6_propietario_anterior_juridico where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info7_propietario_catastral">
        <sql>
        select * from info7_propietario_catastral where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info8_propietario_juridico">
        <sql>
        select * from info8_propietario_juridico where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info9_zmpa">
        <sql>
        select * from info9_zmpa where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info10_infraestructura">
        <sql>
        select * from info10_infraestructura where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info11_estudios_detallados">
        <sql>
        select * from info11_estudios_detallados where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info12_control_calidad_tecnico">
        <sql>
        select * from info12_control_calidad_tecnico where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info13_control_calidad_juridico">
        <sql>
        select * from info13_control_calidad_juridico where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info14_saneamiento_basico">
        <sql>
        select * from info14_saneamiento_basico where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info15_saneamiento_juridico">
        <sql>
        select * from info15_saneamiento_juridico where id_expediente=$id_expediente 
        </sql>
    </Consulta>
    <Consulta id="info16_tributaria">
        <sql>
        select * from info16_tributaria where id_expediente=$id_expediente
        </sql>
    </Consulta>

    <Consulta id="info17_documentos_requeridos">
        <sql>
        select * from info17_documentos_requeridos where id_expediente=$id_expediente
        and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info18_municipios_intersectados">
        <sql>
        select * from info18_municipios_intersectados where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info19_mutacion_predial">
        <sql>
        select * from info19_mutacion_predial where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info20_documentos_requeridos_juridico">
        <sql>
        select * from info20_documentos_requeridos_juridico where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="info21_juridicos">
        <sql>
        select * from info21_juridicos where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>
    <Consulta id="info22_factura_municipio">
        <sql>
        select * from info22_factura_municipio where id_expediente=$id_expediente and consecutivo=$consecutivo
        </sql>
    </Consulta>

    <Consulta id="get_proyectos">
        <sql>
        select ig.id_expediente,id_proyecto,nom_proy,chip_cat,dir_act,bar_ver from info1_general_proyecto ig left join info2_general_predio ip
        on ig.id_expediente=ip.id_expediente
        where 
        upper(ig.id_expediente) like  upper('%' || $filtro || '%') 
        or 
        upper(id_proyecto) like  upper('%' || $filtro || '%') 
        or 
        upper(nom_proy) like upper('%' || $filtro || '%') 
        or 
        upper(chip_cat) like upper('%' || $filtro || '%') 
        or 
        upper(num_mi) like upper('%' || $filtro || '%')
        or 
        upper(ced_cat) like upper('%' || $filtro || '%')
        or 
        upper(bar_ver) like upper('%' || $filtro || '%')
        or 
        upper(upz_upr) like upper('%' || $filtro || '%')
        or 
        upper(dir_act) like upper('%' || $filtro || '%')
        limit 50
        </sql>
    </Consulta>
    <Consulta id="update_info1_general_proyecto">
        <sql>
            update info1_general_proyecto set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info2_general_predio">
        <sql>
            update info2_general_predio set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info3_areas_usos">
        <sql>
            update info3_areas_usos set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info4_avaluos">
        <sql>
            update info4_avaluos set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info5_juridicos">
        <sql>
            update info5_juridicos set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info6_propietario_anterior_juridico">
        <sql>
            update info6_propietario_anterior_juridico set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info7_propietario_catastral">
        <sql>
            update info7_propietario_catastral set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info8_propietario_juridico">
        <sql>
            update info8_propietario_juridico set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info9_zmpa">
        <sql>
            update info9_zmpa set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info10_infraestructura">
        <sql>
            update info10_infraestructura set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>

    <Consulta id="update_info11_estudios_detallados">
        <sql>
            update info11_estudios_detallados set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info12_control_calidad_tecnico">
        <sql>
            update info12_control_calidad_tecnico set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>

    <Consulta id="update_info13_control_calidad_juridico">
        <sql>
            update info13_control_calidad_juridico set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info14_saneamiento_basico">
        <sql>
            update info14_saneamiento_basico set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info15_saneamiento_juridico">
        <sql>
            update info15_saneamiento_juridico set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info16_tributaria">
        <sql>
            update info16_tributaria set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info17_documentos_requeridos">
        <sql>
            update info17_documentos_requeridos set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info18_municipios_intersectados">
        <sql>
            update info18_municipios_intersectados set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info19_mutacion_predial">
        <sql>
            update info19_mutacion_predial set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info20_documentos_requeridos_juridico">
        <sql>
            update info20_documentos_requeridos_juridico set upd_query_alpaca where id_expediente=$id_expediente RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info21_juridicos">
        <sql>
            update info21_juridicos set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_info22_factura_municipio">
        <sql>
            update info22_factura_municipio set upd_query_alpaca where id_expediente=$id_expediente and consecutivo=$consecutivo RETURNING id_expediente
        </sql>
    </Consulta>




    <Consulta id="get_campos_repositorio">
        <sql>
            select
            json_build_object(
                'nombre_documento',nombre,
                'codigo', codigo,
                'field', campo,
                'helper', descripcion,
                'type',tipo,
                'required',obligatorio
                ) as doc
            from 
            (
            select concat(ds.cod_grupo,ds.cod_subgrupo) AS CODIGO,* from doc_grupo dg 
            INNER join doc_subgrupo ds 
            on dg.cod_grupo=ds.cod_grupo
            where ds.cod_grupo =$cod_grupo) as sub
        </sql>
    </Consulta>

    <Consulta id="insertar_repositorio">
        <sql>
           INSERT INTO repositorio_documental 
            VALUES ($id_expediente, $codigo_documento,$atributos,$doc_nombre)
            ON CONFLICT (id_expediente, codigo_documento) DO UPDATE
            SET atributos = $atributos,doc_nombre=$doc_nombre
        </sql>
    </Consulta>

    <Consulta id="get_documentos">
        <sql>
            select * from documentos where identificador=$identificador
        </sql>
    </Consulta>


    <Consulta id="get_datos_repositorio">
        <sql>
        select atributos from repositorio_documental
        where id_expediente=$id_expediente
        and codigo_documento=$codigo_documento
        </sql>
    </Consulta>

    <Consulta id="get_usuarios_rol">
        <sql>
        select usuario_nombre,usuario_usuario from usuario where usuario_rol=$usuario_rol
        </sql>
    </Consulta>
    <Consulta id="get_usuarios_rol_tecnico">
        <sql>
        select usuario_nombre,usuario_usuario from usuario where usuario_rol in(7,9)
        </sql>
    </Consulta>
    <Consulta id="get_usuarios_rol_juridico">
        <sql>
        select usuario_nombre,usuario_usuario from usuario where usuario_rol=10
        </sql>
    </Consulta>
    <Consulta id="get_usuarios">
        <sql>
        select usuario_nombre,usuario_usuario from usuario
        </sql>
    </Consulta>
    <Consulta id="get_usuarios_lista">
        <sql>
        select u.usuario_usuario as username, u.usuario_rol as id_rol, r.descripcion as rol,
            u.usuario_nombre as nombre, u.usuario_correo as correo,
            u.usuario_cargo as cargo,u.usuario_contrato as contrato
            from usuario u join rol r on u.usuario_rol = r.id_rol
        </sql>
    </Consulta>
    <Consulta id="get_roles_lista">
        <sql>
        select *
        from rol
        </sql>
    </Consulta>
    <Consulta id="get_formulario">
        <sql>
        select
        json_build_object(
            'field',field,
            'form',form,
            'label', label,
            'type', type,
            'size', size,
            'helper',helper,
            'enum',d.enum,
            'editable',editable,
            'regex',regex,
            'message',message
            ) as doc
        from modulos m left join (select dominio,
								  json_agg(json_build_object('value',valor,'label',descripcion)) as enum
								  from dominios
group by dominio) as d
        on m.enum=d.dominio
        where tabla=$tabla order by orden
        </sql>
    </Consulta>

    <Consulta id="session">
        <sql>
        select * from usuario
        where usuario_usuario=token
        </sql>
    </Consulta>

    <Consulta id="insertar_asignacion">
        <sql>
        insert into tareas.asignacion values (
            $id_expediente,
            $id_tarea,
            (select usuario from tareas.grupos 
            where id_tarea=$id_tarea and id_grupo=(select id_grupo from usuario where usuario_usuario=$usuario_responsable))
        )
        ON CONFLICT DO NOTHING;
        </sql>
    </Consulta>
    <Consulta id="insertar_asignacion_tecnico">
        <sql>
        insert into tareas.asignacion values (
            $id_expediente,
            $id_tarea,
            $usuario_responsable
        )
        ON CONFLICT (id_expediente,id_tarea) DO UPDATE
            SET usuario = $usuario_responsable
            returning id_expediente
        </sql>
    </Consulta>
    <Consulta id="update_notificacion">
        <sql>
        update tareas.tareas
        set fecha_asignacion = now(), usuario_responsable = $usuario_responsable
        where ruta = $ruta and id_expediente = $id_expediente and estado = 1
        returning id_expediente;
        </sql>
    </Consulta>

    <Consulta id="insertar_notificacion">
        <sql>
        insert into tareas.tareas values(
            (select max (id)+1 from tareas.tareas),
            $id_expediente,
            $ruta_destino,
            token,
            (select usuario from tareas.asignacion 
            where id_expediente=$id_expediente and id_tarea= $tarea_next),
            now(),
            null,
            1,
            true
        )ON CONFLICT DO NOTHING RETURNING usuario_responsable
        </sql>
    </Consulta>



    <Consulta id="aprobado_juridico">
        <sql>
        SELECT CASE WHEN EXISTS (
            SELECT aprobado
            from info13_control_calidad_juridico 
            where id_expediente=$id_expediente
        )
        THEN
            (select CASE WHEN aprobado=1 THEN true
                    ELSE false
            END
        from info13_control_calidad_juridico 
        where id_expediente=$id_expediente)
        ELSE
            false
        END as aprobado
        </sql>
    </Consulta>
    <Consulta id="aprobado_tecnico">
        <sql>
        SELECT CASE WHEN EXISTS (
            SELECT aprobado
            from info12_control_calidad_tecnico 
            where id_expediente=$id_expediente
        )
        THEN
            (select CASE WHEN aprobado=1 THEN true
                    ELSE false
            END
        from info12_control_calidad_tecnico 
        where id_expediente=$id_expediente)
        ELSE
            false
        END as aprobado
        </sql>
    </Consulta>




    <Consulta id="get_tareas">
        <sql>
        select *,
        (select descripcion from tareas.flujo as tf where
        tf.ruta=t.ruta), 
        (select usuario_nombre from usuario as u where
        u.usuario_usuario=t.usuario_asigna)as usuario_nombre,
        (select usuario_nombre from usuario as u where
        u.usuario_usuario=t.usuario_responsable)as usuario_responsable
        from tareas.tareas as t
        where
        usuario_responsable=token and estado=1 and visible=true
        order by fecha_asignacion desc
        </sql>
    </Consulta>

    <Consulta id="update_tareas_estado">
        <sql>
        update tareas.tareas set estado=2, fecha_solucion=now() 
        where id=$id 
        returning id_expediente
        </sql>
    </Consulta>


    <Consulta id="get_numero_tareas">
        <sql>
        select count(*) from tareas.tareas 
        where usuario_responsable=token and estado=1
        </sql>
    </Consulta>

    <Consulta id="get_historia_expediente">
        <sql>
            select *,
            (select usuario_cargo from usuario u where
            u.usuario_usuario=e.usuario_usuario),
            (select usuario_nombre from usuario u where
            u.usuario_usuario=e.usuario_usuario)
            from seguimiento_expedientes e
            where id_expediente=$id_expediente order by iteracion
        </sql>
    </Consulta>


    <Consulta id="asignar_expediente_fisico_paso1">
        <sql>
            update seguimiento_expedientes set fecha_final=now()
            ,activo=false where id_expediente=$id_expediente
            and activo=true;
        </sql>
    </Consulta>
    <Consulta id="asignar_expediente_fisico_paso2">
        <sql>
        insert into 
        seguimiento_expedientes(id_expediente,iteracion,
					    usuario_usuario,activo,fecha_inicio)
            select $id_expediente,
            (select max(iteracion)+1 from seguimiento_expedientes
            where id_expediente=$id_expediente ),
            $id_asignado,true,now();
        </sql>
    </Consulta>
    <Consulta id="get_datos_busqueda_geometria">
        <sql>
            select lotcodigo,chip,direccion_
            from geometria.tabla_lote_catastro 
            where lotcodigo like '%' || $lotcodigo || '%' or chip like '%' || $chip || '%'
            limit 20
        </sql>
    </Consulta>

    <Consulta id="get_geometria_busqueda">
        <sql>
        SELECT ST_AsGeoJSON(st_transform(geom,4326))as geom
        from geometria.lote_catastro
        where lotcodigo =$codigo
        </sql>
    </Consulta>
    <Consulta id="get_geometria_predio">
        <sql>
            SELECT jsonb_build_object(
                'type',     'FeatureCollection',
                'features', jsonb_agg(features.Feature)
            )as geojson from (
            SELECT json_build_object(
                'type',       'Feature',
                'id',         'id',
                'geometry',   ST_AsGeoJSON(ST_Transform(geom,4326))::json,
                'properties', json_build_object(
                    'con', 'hola',
                    'id_avaluo', 'hla'
                )
            ) as Feature
            FROM geometria.lote_asignacion where id_expediente =$id_expediente
            )features
        </sql>
    </Consulta>



   <Consulta id="insertar_dibujo_mapa">
        <sql>
            insert into geometria.dibujo
            values($id_expediente,ST_SetSRID(ST_GeomFromGeoJSON($shape),4326))
            on conflict(id_expediente) do update 
                set geom=ST_SetSRID(ST_GeomFromGeoJSON($shape),4326)
            returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="consultar_permisos">
        <sql>

            select p.id_permiso from usuario u
            inner join rol r on u.usuario_rol=r.id_rol
            left join rol_permisos rp on r.id_rol=rp.id_rol
            inner join permisos p on rp.id_permiso=p.id_permiso
            where usuario_usuario=token

        </sql>
    </Consulta>  

    <Consulta id="expediente_asignado">
        <sql>
        select exists (
        select id_expediente from tareas.tareas 
        where usuario_responsable=token and estado=1 and id_expediente=$id_expediente)
        </sql>
    </Consulta>   

    <Consulta id="reporte_tareas">
        <sql>
        select * from tareas.tareas where usuario_responsable=token
        </sql>
    </Consulta> 
    <Consulta id="reporte_documentos">
        <sql>
            select * from documentos
        </sql>
    </Consulta> 
    
    
    
    
    <Consulta id="reporte_info5">
        <sql>
        select * from info5_juridicos
        natural join info21_juridicos
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info6">
        <sql>
        select * from info6_propietario_anterior_juridico
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info7">
        <sql>
        select * from info7_propietario_catastral
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info8">
        <sql>
        select * from info8_propietario_juridico
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info9">
        <sql>
        select * from info9_zmpa
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info10">
        <sql>
        select * from info10_infraestructura
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info11">
        <sql>
        select * from info11_estudios_detallados
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info12">
        <sql>
        select * from info12_control_calidad_tecnico
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info13">
        <sql>
        select * from info13_control_calidad_juridico
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info14">
        <sql>
        select * from info14_saneamiento_basico
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info15">
        <sql>
        select * from info15_saneamiento_juridico
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
        <Consulta id="reporte_info17">
        <sql>
        select * from info17_documentos_requeridos
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info18">
        <sql>
        select * from info18_municipios_intersectados
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info19">
        <sql>
        select * from info19_mutacion_predial
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="reporte_info22">
        <sql>
        select * from info22_factura_municipio
        natural join(
        SELECT *
        FROM crosstab(
            'select id_expediente,id_tarea,usuario_nombre
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            order by id_expediente,id_tarea'
        ) AS ct(id_expediente TEXT, "Técnico" TEXT, "Jurídico" TEXT, "Sup. Juridico" TEXT, "Sup. Técnico" TEXT)
        )sub
        natural join (
        select id_expediente,nivel_prior as "Nivel de prioridad" from info2_general_predio
        )sub1
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="get_asignacion">
        <sql>
            select id_tarea,usuario_nombre,usuario_cargo
            from tareas.asignacion t 
            left join usuario u
            on t.usuario=u.usuario_usuario
            where id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="get_tipologia">
        <sql>
            select descripcion
            from info5_juridicos ij
            left join tabla_dominios d on ij.tipologia_impuesto_2021::text = d.valor
            and d.dominio = 'Tip_Impuestos_V'
            where ij.id_expediente=$id_expediente
        </sql>
    </Consulta>
    <Consulta id="get_estados_depuracion">
        <sql>
             select t.id_expediente, dep_tec, f_tec, dep_jur, f_jur
            from estado_aprobacion_tecnico t
            join estado_aprobacion_juridico j on t.id_expediente = j.id_expediente
            where t.id_expediente=$id_expediente
        </sql>
    </Consulta>




    <Consulta id="reporte_actividades">
        <sql>


select * from (

select * from info1_general_proyecto 
natural join info2_general_predio
natural join info3_areas_usos
natural join info4_avaluos
)b1
natural join 
(
select i.id_expediente,
sub.fecha_asignacion,
sub12.dep_tec,
sub1.f_tec,
sub13.dep_jur,
sub2.f_jur,
sub3.dep_sup_tec,sub3.f_sup_tec,
sub4.dep_sup_jur,sub4.f_sup_jur,
sub9.aprobado_tecnico,sub9.fecha_aprob_tecnico,sub9.mot_dev_tec,
sub10.aprobado_juridico,sub10.fecha_aprob_juridico,sub10.mot_dev_jur,
tecnico,juridico,sup_tecnico,sup_juridico,
NIVEL_PRIOR as nivel_prioridad,
sub11.estrato_tecnico,sub11.estrato_juridico,sub11.muestra_tecnica,sub11.muestra_juridica
from info1_general_proyecto i
left join
(
select id_expediente,NIVEL_PRIOR from info2_general_predio 
)subx
on i.id_expediente=subx.id_expediente	  
	 
	  	  
left join
(
	
select id_expediente,min(fecha_asignacion) as fecha_asignacion
from tareas.tareas
where ruta in(1,2)
group by id_expediente
	
)sub
on i.id_expediente=sub.id_expediente

left join
(

select sub1.id_expediente,
(case when aprobado=1 then 'APROBADO' 
  when aprobado=2 then 
   CASE WHEN COALESCE(sub3.id_expediente, '') != '' THEN 'EN REVISIÓN' ELSE 'DEVUELTO' END
 ELSE  (case when coalesce(sub3.id_expediente,'') = '' then (case when sum=13 then 'EN GESTIÓN' ELSE 'ASIGNADO' END) else 'EN REVISIÓN' end)
 END) as dep_tec
from (	  
select
I.id_expediente,
(case when coalesce(ID_PROYECTO,'') = '' then 0 else 1 end)+
(case when coalesce(PORCENTAJE_AREA_EN_DUP,0) = 0 then 0 else 1 end)+  
(case when coalesce(AREA_EN_DUP,0) = 0 then 0 else 1 end)+	 
(case when coalesce(NOM_PROY,'') = '' then 0 else 1 end)+
(case when coalesce(CHIP_CAT,'') = '' then 0 else 1 end)+
(case when coalesce(NUM_MI,'') = '' then 0 else 1 end)+
(case when coalesce(DIR_ACT,'') = '' then 0 else 1 end)+
(case when coalesce(DEST_ECONO,0) = 0 then 0 else 1 end)+
(case when coalesce(DEST_USO_EAAB,0) = 0 then 0 else 1 end)+
(case when coalesce(NIVEL_PRIOR,0) = 0 then 0 else 1 end)+
(case when coalesce(OBS_ESPECIFICAS,'') = '' then 0 else 1 end)+
(case when coalesce(AVAL,0) = 0 then 0 else 1 end)+
(case when coalesce(TIP_INFRA,'{}') = '{}' then 0 else 1 end) as sum	  
from info1_general_proyecto I
LEFT JOIN info2_general_predio J
on I.id_expediente=J.id_expediente
LEFT JOIN info4_avaluos	K
on I.id_expediente=K.id_expediente	
LEFT JOIN info10_infraestructura L
on I.id_expediente=L.id_expediente
)sub1
LEFT JOIN info12_control_calidad_tecnico sub2
on sub1.id_expediente=sub2.id_expediente	
LEFT JOIN (
select distinct id_expediente 
from tareas.tareas
where estado=1 and ruta=3
)sub3
on sub1.id_expediente=sub3.id_expediente	 

)sub12
on i.id_expediente=sub12.id_expediente
	  
left join
(
	
select t.id_expediente,fecha_solucion as f_tec
from tareas.tareas t
where ruta=1 and fecha_asignacion= 
(select max(fecha_asignacion) from tareas.tareas tt where tt.id_expediente=t.id_expediente and tt.ruta=1)
	
)sub1
on i.id_expediente=sub1.id_expediente

left join
(
select sub1.id_expediente,
(case when aprobado=1 then 'APROBADO' 
 when aprobado=2 then 
 CASE WHEN COALESCE(sub3.id_expediente, '') != '' THEN 'EN REVISIÓN' ELSE 'DEVUELTO' END
 ELSE  (case when coalesce(sub3.id_expediente,'') = '' then (case when sum=12 then 'EN GESTIÓN' ELSE 'ASIGNADO' END) else 'EN REVISIÓN' end)
 END) as dep_jur
from (
select 
I.id_expediente,
(case when coalesce(ESTADO_FOLIO,0) = 0 then 0 else 1 end)+
(case when coalesce(PRED_ADQ,0) = 0 then 0 else 1 end)+
(case when coalesce(DOC_NUM,0) = 0 then 0 else 1 end)+
(case when coalesce(DOC_FECHA,now()) = now() then 0 else 1 end)+
(case when coalesce(K.NOM_PROP_MI,'') = '' then 0 else 1 end)+
(case when coalesce(K.TIPO_DOC_PROP,'') = '' then 0 else 1 end)+
(case when coalesce(K.NUM_DOC_PROP,'') = '' then 0 else 1 end)+
(case when coalesce(K.PORCENT_COPROP,0) = 0 then 0 else 1 end)+
(case when coalesce(L.NOM_ANTE_PROP,'') = '' then 0 else 1 end)+
(case when coalesce(L.TIPO_DOC_PROP,'') = '' then 0 else 1 end)+
(case when coalesce(L.NUM_DOC_PROP,'') = '' then 0 else 1 end)+
(case when coalesce(L.PORCENT_COPROP,0) = 0 then 0 else 1 end) AS sum
from info5_juridicos I
LEFT JOIN (select * from info21_juridicos where consecutivo=1) J
on I.id_expediente=J.id_expediente
LEFT JOIN (select * from info8_propietario_juridico where consecutivo=1) K
on I.id_expediente=K.id_expediente
LEFT JOIN (select * from info6_propietario_anterior_juridico where consecutivo=1) L
on I.id_expediente=L.id_expediente
)sub1
LEFT JOIN info13_control_calidad_juridico sub2
on sub1.id_expediente=sub2.id_expediente
LEFT JOIN (
select distinct id_expediente 
from tareas.tareas
where estado=1 and ruta=4
)sub3
on sub1.id_expediente=sub3.id_expediente	  
	  
)sub13
on i.id_expediente=sub13.id_expediente
	  
left join
(
select t.id_expediente,fecha_solucion as f_jur
from tareas.tareas t
where ruta=2 and fecha_asignacion= 
(select max(fecha_asignacion) from tareas.tareas tt where tt.id_expediente=t.id_expediente and tt.ruta=2)
	
)sub2
on i.id_expediente=sub2.id_expediente
  
  
left join
(
select t.id_expediente,(case when estado=2 then 'SI' ELSE 'PENDIENTE' END ) as dep_sup_tec,fecha_solucion as f_sup_tec
from tareas.tareas t
where ruta=3 and fecha_asignacion= 
(select max(fecha_asignacion) from tareas.tareas tt where tt.id_expediente=t.id_expediente and tt.ruta=3)

)sub3
on i.id_expediente=sub3.id_expediente

left join
(
	
select t.id_expediente,(case when estado=2 then 'SI' ELSE 'PENDIENTE' END ) as dep_sup_jur,fecha_solucion as f_sup_jur
from tareas.tareas t
where ruta=4 and fecha_asignacion= 
(select max(fecha_asignacion) from tareas.tareas tt where tt.id_expediente=t.id_expediente and tt.ruta=4)	

)sub4
on i.id_expediente=sub4.id_expediente

left join
(
select id_expediente,(select usuario_nombre from usuario where usuario_usuario=t.usuario) as tecnico
from tareas.asignacion t
where id_tarea=2
)sub5
on i.id_expediente=sub5.id_expediente

left join
(
select id_expediente,(select usuario_nombre from usuario where usuario_usuario=t.usuario) as juridico
from tareas.asignacion t
where id_tarea=3
)sub6
on i.id_expediente=sub6.id_expediente

left join
(
select id_expediente,(select usuario_nombre from usuario where usuario_usuario=t.usuario) as sup_tecnico
from tareas.asignacion t
where id_tarea=5
)sub7
on i.id_expediente=sub7.id_expediente

left join
(
select id_expediente,(select usuario_nombre from usuario where usuario_usuario=t.usuario) as sup_juridico
from tareas.asignacion t
where id_tarea=4
)sub8
on i.id_expediente=sub8.id_expediente

left join
(
SELECT id_expediente,(CASE WHEN aprobado=1 THEN 'SI' WHEN aprobado=2 THEN 'NO' WHEN aprobado=3 THEN 'PENDIENTE' ELSE '' END)AS aprobado_tecnico,fecha_aprob as fecha_aprob_tecnico, array_agg(J.descripcion)as mot_dev_tec 
FROM info12_control_calidad_tecnico I 
LEFT JOIN (select * from dominios where dominio='Dom_Mot_Dev_Tec') J 
ON J.valor = ANY(I.mot_dev_tec) 	
GROUP BY id_expediente,fecha_aprob
)sub9
on i.id_expediente=sub9.id_expediente

left join
(
SELECT id_expediente,(CASE WHEN aprobado=1 THEN 'SI' WHEN aprobado=2 THEN 'NO' WHEN aprobado=3 THEN 'PENDIENTE' ELSE '' END)AS aprobado_juridico  ,fecha_aprob as fecha_aprob_juridico, array_agg(J.descripcion)as mot_dev_jur 
FROM info13_control_calidad_juridico I 
LEFT JOIN (select * from dominios where dominio='Dom_Mot_Dev_Juc') J 
ON J.valor = ANY(I.mot_dev_jur) 	
GROUP BY id_expediente,fecha_aprob
)sub10
on i.id_expediente=sub10.id_expediente
	  
left join estrato sub11
on i.id_expediente=sub11.id_expediente
)b2
order by id_expediente
        </sql>
    </Consulta>

    <Consulta id="tributaria_principal">
        <sql>
        select
            I.id_expediente,
            CHIP_CAT,
            NUM_MI,
            (select split_part(descripcion,'-',2) AS MPIO from dominios where dominio='TABLA_MUNICIPIO' and valor=I.MPIO),
            DEST_IGAC,
            DEST_CAT,
            CED_CAT,
            DIR_ACT,
            FISCAL,
            COD_DUP,
            FECHA_ACTADM,
            OBJET_RES,
            AREAT_PREDIO,
            AREA_EP,
            AREA_CAT,
            AREA_FMI,
            AT_GEO,
            AREA_DEFINITIVA_DEPURACION,
            AREA_EN_ZMPA,
            AREA_FUERA_EN_ZMPA,
            K.TIPOLOGIA_IMPUESTO_2020 AS TIPOLOGIA_ZMPA_2020,
            K.TIPOLOGIA_IMPUESTO_2021 AS TIPOLOGIA_ZMPA_2021,
            L.TIPOLOGIA_IMPUESTO_2020 AS TIPOLOGIA_IMPUESTOS_VIGENCIA_2020,
            L.TIPOLOGIA_IMPUESTO_2021 AS TIPOLOGIA_IMPUESTOS_VIGENCIA_2021,
            VAL_TOT_AV_CAT
            from info2_general_predio I 
            LEFT JOIN info1_general_proyecto J 
            on I.id_expediente=J.id_expediente
            LEFT JOIN info3_areas_usos K
            on I.id_expediente=K.id_expediente	  
            LEFT JOIN info5_juridicos L
            on I.id_expediente=L.id_expediente
            LEFT JOIN info4_avaluos M	  
            on I.id_expediente=M.id_expediente
            order by id_expediente
        </sql>
    </Consulta>


    <Consulta id="tributaria_zmpa">
        <sql>
        select
        id_expediente,
        consecutivo,
        ACTADM_ZMPA 
        from info9_zmpa
        order by id_expediente
        </sql>
    </Consulta>
    <Consulta id="tributaria_juridico">
        <sql>
        select 
        id_expediente,
        consecutivo,
        porcent_prop 
        from info21_juridicos
        order by id_expediente
        </sql>
    </Consulta>



    <Consulta id="estadistica1">
        <sql>
        SELECT COUNT(*) as estadistica FROM (SELECT DISTINCT identificador FROM documentos) AS temp;
        </sql>
    </Consulta>
    <Consulta id="estadistica2">
        <sql>
        select count(*) as estadistica from documentos
        </sql>
    </Consulta>
    <Consulta id="estadistica3">
        <sql>
        select count(*) as estadistica from info12_control_calidad_tecnico
        where aprobado =1
        </sql>
    </Consulta>
    <Consulta id="estadistica4">
        <sql>
        select count(*) as estadistica from auditoria
        </sql>
    </Consulta>
    <Consulta id="estadistica5">
        <sql>
        select count(*) as estadistica from info13_control_calidad_juridico
        where aprobado =1
        </sql>
    </Consulta>
    <Consulta id="estadistica6">
        <sql>
        select count(*) as estadistica from info14_saneamiento_basico
        </sql>
    </Consulta>
    <Consulta id="estadistica7">
        <sql>
        select count(*) as estadistica from info15_saneamiento_juridico
        </sql>
    </Consulta>
    <Consulta id="estadistica8">
        <sql>
        select count(*) as estadistica from info9_zmpa
        </sql>
    </Consulta>





    <Consulta id="grafico1">
        <sql>
            select array_agg(grupo) as categoria,array_agg(cuenta)as data from(
            select zona as grupo, count(zona)as cuenta from info2_general_predio 
            where zona is not null group by zona)sub
        </sql>
    </Consulta>
    <Consulta id="grafico2">
        <sql>
            select array_agg(grupo) as categoria,array_agg(cuenta)as data from(
            select clas_suelo as grupo, count(clas_suelo)as cuenta from info2_general_predio 
            where clas_suelo is not null group by clas_suelo)sub
        </sql>
    </Consulta>
    <Consulta id="grafico3">
        <sql>
        select array_agg(grupo) as categoria,array_agg(cuenta)as data from(
        select tipologia_impuesto_2020 as grupo, count(tipologia_impuesto_2020)as cuenta from info3_areas_usos
        where tipologia_impuesto_2020 is not null group by tipologia_impuesto_2020)sub	
        </sql>
    </Consulta>
    <Consulta id="grafico4">
        <sql>
            select fecha::date as grupo, count(fecha::date)as cuenta from auditoria 
            group by fecha::date order by fecha::date
        </sql>
    </Consulta>
    <Consulta id="grafico5">
        <sql>
        select array_agg(grupo) as categoria,array_agg(cuenta)as data from(
            select nivel_prior as grupo, count(nivel_prior)as cuenta from info2_general_predio 
            where nivel_prior is not null group by nivel_prior)sub
        </sql>
    </Consulta>

    <Consulta id="grafico6">
        <sql>
        select array_agg(grupo) as categoria,array_agg(cuenta)as data from(
        select caso as grupo, count(caso)as cuenta from (

        select sub1.id_expediente,
        (case when aprobado=1 then 'APROBADO' 
         when aprobado=2 then 
            CASE WHEN COALESCE(sub3.id_expediente, '') != '' THEN 'EN REVISIÓN' ELSE 'DEVUELTO' END
        ELSE  (case when coalesce(sub3.id_expediente,'') = '' then (case when sum=12 then 'EN GESTIÓN' ELSE 'ASIGNADO' END) else 'EN REVISIÓN' end)
        END) as caso
        from (
        select 
        I.id_expediente,
        (case when coalesce(ESTADO_FOLIO,0) = 0 then 0 else 1 end)+
        (case when coalesce(PRED_ADQ,0) = 0 then 0 else 1 end)+
        (case when coalesce(DOC_NUM,0) = 0 then 0 else 1 end)+
        (case when coalesce(DOC_FECHA,now()) = now() then 0 else 1 end)+
        (case when coalesce(K.NOM_PROP_MI,'') = '' then 0 else 1 end)+
        (case when coalesce(K.TIPO_DOC_PROP,'') = '' then 0 else 1 end)+
        (case when coalesce(K.NUM_DOC_PROP,'') = '' then 0 else 1 end)+
        (case when coalesce(K.PORCENT_COPROP,0) = 0 then 0 else 1 end)+
        (case when coalesce(L.NOM_ANTE_PROP,'') = '' then 0 else 1 end)+
        (case when coalesce(L.TIPO_DOC_PROP,'') = '' then 0 else 1 end)+
        (case when coalesce(L.NUM_DOC_PROP,'') = '' then 0 else 1 end)+
        (case when coalesce(L.PORCENT_COPROP,0) = 0 then 0 else 1 end) AS sum
        from info5_juridicos I
        LEFT JOIN (select * from info21_juridicos where consecutivo=1) J
        on I.id_expediente=J.id_expediente
        LEFT JOIN (select * from info8_propietario_juridico where consecutivo=1) K
        on I.id_expediente=K.id_expediente
        LEFT JOIN (select * from info6_propietario_anterior_juridico where consecutivo=1) L
        on I.id_expediente=L.id_expediente
        )sub1
        LEFT JOIN info13_control_calidad_juridico sub2
        on sub1.id_expediente=sub2.id_expediente
        LEFT JOIN (
        select distinct id_expediente 
        from tareas.tareas
        where estado=1 and ruta=4
        )sub3
        on sub1.id_expediente=sub3.id_expediente

        )sub1
        group by caso)sub	  
        </sql>
    </Consulta>



    <Consulta id="grafico7">
        <sql>
            select array_agg(grupo) as categoria,array_agg(cuenta)as data from(
            select caso as grupo, count(caso)as cuenta from
            (
            select sub1.id_expediente,
            (case when aprobado=1 then 'APROBADO' 
             when aprobado=2 then 
                CASE WHEN COALESCE(sub3.id_expediente, '') != '' THEN 'EN REVISIÓN' ELSE 'DEVUELTO' END
            ELSE  (case when coalesce(sub3.id_expediente,'') = '' then (case when sum=13 then 'EN GESTIÓN' ELSE 'ASIGNADO' END) else 'EN REVISIÓN' end)
            END) as caso
            from (	  
            select
            I.id_expediente,
            (case when coalesce(ID_PROYECTO,'') = '' then 0 else 1 end)+
            (case when coalesce(PORCENTAJE_AREA_EN_DUP,0) = 0 then 0 else 1 end)+  
            (case when coalesce(AREA_EN_DUP,0) = 0 then 0 else 1 end)+	 
            (case when coalesce(NOM_PROY,'') = '' then 0 else 1 end)+
            (case when coalesce(CHIP_CAT,'') = '' then 0 else 1 end)+
            (case when coalesce(NUM_MI,'') = '' then 0 else 1 end)+
            (case when coalesce(DIR_ACT,'') = '' then 0 else 1 end)+
            (case when coalesce(DEST_ECONO,0) = 0 then 0 else 1 end)+
            (case when coalesce(DEST_USO_EAAB,0) = 0 then 0 else 1 end)+
            (case when coalesce(NIVEL_PRIOR,0) = 0 then 0 else 1 end)+
            (case when coalesce(OBS_ESPECIFICAS,'') = '' then 0 else 1 end)+
            (case when coalesce(AVAL,0) = 0 then 0 else 1 end)+
            (case when coalesce(TIP_INFRA,'{}') = '{}' then 0 else 1 end) as sum	  
            from info1_general_proyecto I
            LEFT JOIN info2_general_predio J
            on I.id_expediente=J.id_expediente
            LEFT JOIN info4_avaluos	K
            on I.id_expediente=K.id_expediente	
            LEFT JOIN info10_infraestructura L
            on I.id_expediente=L.id_expediente
            )sub1
            LEFT JOIN info12_control_calidad_tecnico sub2
            on sub1.id_expediente=sub2.id_expediente	
            LEFT JOIN (
            select distinct id_expediente 
            from tareas.tareas
            where estado=1 and ruta=3
            )sub3
            on sub1.id_expediente=sub3.id_expediente		
            )sub1
            group by caso)sub
        </sql>
    </Consulta>




    <Consulta id="get_metadata">
        <sql>
            select * from doc_grupo
        </sql>
    </Consulta>



    <Consulta id="get_permisos">
        <sql>
           select jsonb_agg(id_permiso)as permisos
            from(
            select p.id_permiso
            from usuario u
            inner join rol_permisos r
            on r.id_rol=u.usuario_rol
            inner join permisos p
            on r.id_permiso=p.id_permiso

            where usuario_usuario=token
            union 
            select id_permiso
            from usuario u
            natural join usr_permisos up
            where usuario_usuario=token

            )As s
        </sql>
    </Consulta>


    <Consulta id="get_flujo">
        <sql>
            select 
                t.ruta,
                id_tarea_next,
                path,
                (select usuario_nombre from usuario where usuario_usuario=t.usuario_responsable),
                f.descripcion as descripcion,
                ta.descripcion as perfil,
                estado,
                fecha_asignacion
            from tareas.tareas t left join (
            select id_tarea_next,concat(id_tarea,'-',id_tarea_next)as path,ruta,descripcion
            from tareas.flujo
            ) f
            on t.ruta=f.ruta 
            inner join tareas.actividades ta on f.id_tarea_next=ta.id_tarea
            where id_expediente=$id_expediente order by fecha_asignacion
        </sql>
    </Consulta>


    <Consulta id="insertar_vacio">
        <sql>
           
           insert into insert-dinamico(id_expediente) values ($id_expediente)
            returning id_expediente;
        </sql>
    </Consulta>
    <Consulta id="get_consecutivos">
        <sql>
           
           select consecutivo from insert-dinamico where id_expediente=$id_expediente
        </sql>
    </Consulta>



    <Consulta id="tengo_predio">
        <sql>
        select exists(
           select * from tareas.tareas
            where id_expediente=$id_expediente 
            and usuario_responsable=token and estado=1)
        </sql>
    </Consulta>

    <Consulta id="get_soportes">
        <sql>
        select * from documentos where identificador=$identificador	  
        </sql>
    </Consulta>

    <Consulta id="insert_consecutivo">
        <sql>

       insert into insert-dinamico(id_expediente,consecutivo)
        values ($id_expediente,coalesce((select max(consecutivo)+1 
		from insert-dinamico where id_expediente=$id_expediente),1)
	  	)returning id_expediente


        </sql>
    </Consulta>

    <Consulta id="delete_consecutivo">
        <sql>

        delete from insert-dinamico where id_expediente=$id_expediente and consecutivo=$consecutivo returning id_expediente


        </sql>
    </Consulta>

    <Consulta id="info_header_form">
        <sql>

        select chip_cat,num_mi,cod_predial from info2_general_predio
        where id_expediente=$id_expediente


        </sql>
    </Consulta>

    <Consulta id="get_dominios">
        <sql>
        select distinct dominio
        from dominios
        </sql>
    </Consulta>

    <Consulta id="get_valores_dominios">
        <sql>
        select *
            from dominios
            where dominio = $dominio
            order by valor
        </sql>
    </Consulta>

    <Consulta id="insert_valor_dominios">
        <sql>
        INSERT INTO dominios
            VALUES ($dominio, $valor,$descripcion)
            ON CONFLICT (dominio, valor) DO UPDATE
            SET descripcion = $descripcion
            returning dominio
        </sql>
    </Consulta>

    <Consulta id="reporte_dominios">
        <sql>
        select *
        from dominios
        where dominio = $dominio
        order by valor
        </sql>
    </Consulta>

    <Consulta id="get_tipologias">
        <sql>
        select *
        from doc_grupo
        order by cod_grupo
        </sql>
    </Consulta>

    <Consulta id="insert_valor_tipologia">
        <sql>
        INSERT INTO doc_grupo
            VALUES ($cod_grupo, $nombre, $componente, $formato, $responsable)
            ON CONFLICT (cod_grupo) DO UPDATE
            SET nombre = $nombre, componente = $componente, formato = $formato, responsable = $responsable
            returning doc_grupo
        </sql>
    </Consulta>

    <Consulta id="reporte_tipologias">
        <sql>
        select *
        from doc_grupo
        order by cod_grupo
        </sql>
    </Consulta>

    <Consulta id="insert_valor_usuario">
        <sql>
        INSERT INTO usuario
            VALUES ((select max (usuario_id)+1 from usuario),$usuario_usuario, md5('123456'),$usuario_rol, $usuario_nombre, $usuario_correo, $usuario_cargo, true, 
            null,$usuario_contrato,null)
            ON CONFLICT (usuario_usuario) DO UPDATE
            SET usuario_rol = $usuario_rol, usuario_nombre = $usuario_nombre, usuario_correo = $usuario_correo,
            usuario_cargo = $usuario_cargo, usuario_contrato = $usuario_contrato
            returning usuario_id
        </sql>
    </Consulta>

    <Consulta id="insert_rol_admin">
        <sql>
        INSERT INTO usr_permisos
            VALUES ($id_usuario,10)
            ON CONFLICT (usuario_id,id_permiso) DO UPDATE
            SET id_permiso = 10
            returning usuario_id
        </sql>
    </Consulta>

    <Consulta id="insert_calidad_tecnico">
        <sql>
        INSERT INTO info12_control_calidad_tecnico
            VALUES ($id_expediente,$aprobado, null,$obs, null, now())
            ON CONFLICT (id_expediente) DO UPDATE
            SET aprobado = $aprobado, obs = $obs, fecha_aprob = now()
            returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="insert_calidad_juridico">
        <sql>
        INSERT INTO info13_control_calidad_juridico
            VALUES ($id_expediente,$aprobado, null,$obs, null, now())
            ON CONFLICT (id_expediente) DO UPDATE
            SET aprobado = $aprobado, obs = $obs, fecha_aprob = now()
            returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="update_tareas_calidad_tecnico">
        <sql>
        UPDATE tareas.tareas
            SET estado = 2,fecha_solucion = now()
            WHERE id_expediente = $id_expediente and ruta = 3 and estado = 1
            returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="update_tareas_calidad_juridico">
        <sql>
        UPDATE tareas.tareas
            SET estado = 2,fecha_solucion = now()
            WHERE id_expediente = $id_expediente and ruta = 4 and estado = 1
            returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="borrar_tarea">
        <sql>
        DELETE from tareas.tareas
        WHERE id_expediente = $id_expediente and ruta = ANY($ruta_close::int[])
        returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="cerrar_tarea">
        <sql>
        UPDATE tareas.tareas
            SET estado = 2,fecha_solucion = now()
            WHERE id_expediente = $id_expediente and ruta = ANY($ruta_close::int[]) and estado = 1
            returning id_expediente
        </sql>
    </Consulta>

    <Consulta id="abrir_tarea">
        <sql>
        UPDATE tareas.tareas
            SET estado = 1,fecha_solucion = null
            WHERE id_expediente = $id_expediente and ruta = ANY($ruta_close::int[]) and estado = 2
            returning id_expediente
        </sql>
    </Consulta>


</Consultas>